<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
<form onsubmit="return sendNickname();" id="nicknameBox">
    <input type="text" id="nickName" placeholder="Add Your Name to start chat">
    <input type="submit" value="Start">
</form>

<!-- list where all users will be displayed -->

<ul id="users"></ul>

<form onsubmit="return sendMessage();" id="messageBox" style="display: none">
    <input type="text" id="message" placeholder="send message">
    <input type="submit" value="Send Message">
</form>

<!-- list where all messages will be displayed -->

<ul id="messages"></ul>
<script src="js/jquery.min.js"></script>
<script src="js/socket.io.js"></script>
<script>
    var server = "http://localhost:8080";
    var io = io(server);

    let receiver = "";
    let sender = "";

    io.emit("Post.index", 'all posts');

    // set nickname
    function sendNickname() {
        // send request to server
        // get nickName
        let nickName = document.getElementById("nickName").value;
        //sending nickName from client
        io.emit("Post.index", nickName);
        sender = nickName;
        document.getElementById("messageBox").style.display = "block";
        document.getElementById("nicknameBox").style.display = "none";
        // $("#messageBox").attr("display", "block");
        document.getElementById("nickName").value = "";
        return false;
    }

    // delete
    function deleteMessage(self) {
        // send request to server
        io.emit("delete_message", self.getAttribute("data-id"));
    }

    function sendMessage() {
        // get message
        let message = document.getElementById("message").value;
        //sending message from client
        io.emit("new_message", message);

        // this is to prevent form to submitting
        return false;
    }

    // client will listen from server
    io.on("Post.index", function (data) {
        console.log("Server says", data);
        data.forEach(post => {
            //display message
            // creates new DOM
            let li = document.createElement("li");

            // give it unique ID
            li.id = "content_" + post.id;
            // add message content as HTML
            li.innerHTML = post.content;
            li.innerHTML += " ---> <button data-id='" + post.id + "' onclick='deleteMessage(this);'>Delete</button>";
            // append at the end of list
            messages.append(li);
        })

    });

    // attach listener for delete_message event
    io.on("delete_message", function (messageID) {
        // get node by ID
        var node = document.getElementById("name_" + messageID);
        node.innerHTML = "This message has been deleted";
    });

    // attach listener for user_connected event
    io.on("user_connected", function (userName) {
        // get node by ID
        console.log("userName", userName);

        let html = "";
        html += "<li><button onclick='onUserSelected(this.innerHTML);'>" + userName + "</button></li><br>";

        document.getElementById("users").innerHTML += html;
    });

    function onUserSelected(userName) {
        console.log('selected user', userName);
        receiver = userName;
    }
</script>
</body>
</html>